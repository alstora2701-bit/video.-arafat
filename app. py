    import os
from flask import Flask, request, render_template_string, send_file
from moviepy.editor import VideoFileClip, AudioFileClip
from speech_recognition import Recognizer, AudioFile
from googletrans import Translator
from gtts import gTTS

app = Flask(__name__)

UPLOAD_FOLDER = 'uploads'
os.makedirs(UPLOAD_FOLDER, exist_ok=True)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER

# Ø§Ù„Ù„ØºØ§Øª Ø§Ù„Ù…Ø¯Ø¹ÙˆÙ…Ø©
LANGUAGES = {
    "ar": "Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©",
    "en": "Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©",
    "fr": "Ø§Ù„ÙØ±Ù†Ø³ÙŠØ©",
    "es": "Ø§Ù„Ø¥Ø³Ø¨Ø§Ù†ÙŠØ©",
    "de": "Ø§Ù„Ø£Ù„Ù…Ø§Ù†ÙŠØ©",
    "hi": "Ø§Ù„Ù‡Ù†Ø¯ÙŠØ©",
    "zh-cn": "Ø§Ù„ØµÙŠÙ†ÙŠØ© (Ù…Ø¨Ø³Ø·Ø©)"
}

# HTML Ù…Ø¯Ù…Ø¬ Ø¯Ø§Ø®Ù„ Ø§Ù„ÙƒÙˆØ¯
HTML_TEMPLATE = """
<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <title>Ø¯Ø¨Ù„Ø¬Ø© Ø§Ù„ÙÙŠØ¯ÙŠÙˆ</title>
    <style>
        body { font-family: sans-serif; text-align: center; margin-top: 50px; background-color: #f4f4f4; }
        .container { background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0, 0, 0, 0.1); display: inline-block; }
        input[type="file"], select { margin: 10px 0; padding: 8px; }
        input[type="submit"] { padding: 10px 20px; font-size: 16px; cursor: pointer; background-color: #007BFF; color: white; border: none; border-radius: 5px; }
        input[type="submit"]:hover { background-color: #0056b3; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¬ Ø¯Ø¨Ù„Ø¬Ø© Ø§Ù„ÙÙŠØ¯ÙŠÙˆ</h1>
        <form action="/dub" method="post" enctype="multipart/form-data">
            <label for="video">Ø§Ø®ØªØ± Ù…Ù„Ù ÙÙŠØ¯ÙŠÙˆ:</label><br>
            <input type="file" name="video" id="video" accept="video/*" required><br>

            <label for="language">Ø§Ø®ØªØ± Ù„ØºØ© Ø§Ù„Ø¯Ø¨Ù„Ø¬Ø©:</label><br>
            <select name="language" id="language" required>
                {% for code, name in languages.items() %}
                    <option value="{{ code }}">{{ name }}</option>
                {% endfor %}
            </select><br>

            <input type="submit" value="Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¯Ø¨Ù„Ø¬Ø©">
        </form>
    </div>
</body>
</html>
"""

@app.route('/')
def index():
    return render_template_string(HTML_TEMPLATE, languages=LANGUAGES)

@app.route('/dub', methods=['POST'])
def dub_video():
    if 'video' not in request.files:
        return "Ù„Ù… ÙŠØªÙ… Ø±ÙØ¹ Ø£ÙŠ ÙÙŠØ¯ÙŠÙˆ", 400

    video_file = request.files['video']
    if video_file.filename == '':
        return "Ù„Ù… ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ù…Ù„Ù", 400

    # Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù„ØºØ© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©
    target_lang = request.form.get('language')
    if target_lang not in LANGUAGES:
        return "Ø§Ø®ØªÙŠØ§Ø± Ù„ØºØ© ØºÙŠØ± ØµØ§Ù„Ø­", 400

    # Ø­ÙØ¸ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
    video_path = os.path.join(app.config['UPLOAD_FOLDER'], video_file.filename)
    video_file.save(video_path)

    # 1. Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„ØµÙˆØª
    video_clip = VideoFileClip(video_path)
    audio_clip_path = os.path.join(app.config['UPLOAD_FOLDER'], "temp_audio.wav")
    video_clip.audio.write_audiofile(audio_clip_path)

    # 2. ØªØ­ÙˆÙŠÙ„ Ø§Ù„ÙƒÙ„Ø§Ù… Ø¥Ù„Ù‰ Ù†Øµ (Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ© ÙÙ‚Ø· ÙƒØ¨Ø¯Ø§ÙŠØ©)
    r = Recognizer()
    with AudioFile(audio_clip_path) as source:
        audio = r.record(source)
    try:
        text_en = r.recognize_google(audio, language='en-US')
    except Exception as e:
        return f"Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„ÙƒÙ„Ø§Ù…: {e}", 500

    # 3. Ø§Ù„ØªØ±Ø¬Ù…Ø© Ø¥Ù„Ù‰ Ø§Ù„Ù„ØºØ© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©
    translator = Translator()
    text_translated = translator.translate(text_en, dest=target_lang).text

    # 4. ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù†Øµ Ø§Ù„Ù…ØªØ±Ø¬Ù… Ø¥Ù„Ù‰ ØµÙˆØª
    tts = gTTS(text=text_translated, lang=target_lang, slow=False)
    new_audio_path = os.path.join(app.config['UPLOAD_FOLDER'], "new_audio.mp3")
    tts.save(new_audio_path)

    # 5. Ø¯Ù…Ø¬ Ø§Ù„ØµÙˆØª Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù…Ø¹ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
    new_audio_clip = AudioFileClip(new_audio_path)
    final_clip = video_clip.set_audio(new_audio_clip)
    final_video_path = os.path.join(app.config['UPLOAD_FOLDER'], f"dubbed_{video_file.filename}")
    final_clip.write_videofile(final_video_path, codec="libx264", audio_codec="aac")

    # ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø¤Ù‚ØªØ©
    os.remove(video_path)
    os.remove(audio_clip_path)
    os.remove(new_audio_path)

    return send_file(final_video_path, as_attachment=True)

if __name__ == '__main__':
    app.run(debug=True)
