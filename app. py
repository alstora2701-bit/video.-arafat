    import os
from flask import Flask, request, render_template_string, send_file
from moviepy.editor import VideoFileClip, AudioFileClip
from speech_recognition import Recognizer, AudioFile
from googletrans import Translator
from gtts import gTTS

app = Flask(__name__)

UPLOAD_FOLDER = 'uploads'
os.makedirs(UPLOAD_FOLDER, exist_ok=True)
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER

# اللغات المدعومة
LANGUAGES = {
    "ar": "العربية",
    "en": "الإنجليزية",
    "fr": "الفرنسية",
    "es": "الإسبانية",
    "de": "الألمانية",
    "hi": "الهندية",
    "zh-cn": "الصينية (مبسطة)"
}

# HTML مدمج داخل الكود
HTML_TEMPLATE = """
<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <title>دبلجة الفيديو</title>
    <style>
        body { font-family: sans-serif; text-align: center; margin-top: 50px; background-color: #f4f4f4; }
        .container { background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0, 0, 0, 0.1); display: inline-block; }
        input[type="file"], select { margin: 10px 0; padding: 8px; }
        input[type="submit"] { padding: 10px 20px; font-size: 16px; cursor: pointer; background-color: #007BFF; color: white; border: none; border-radius: 5px; }
        input[type="submit"]:hover { background-color: #0056b3; }
    </style>
</head>
<body>
    <div class="container">
        <h1>🎬 دبلجة الفيديو</h1>
        <form action="/dub" method="post" enctype="multipart/form-data">
            <label for="video">اختر ملف فيديو:</label><br>
            <input type="file" name="video" id="video" accept="video/*" required><br>

            <label for="language">اختر لغة الدبلجة:</label><br>
            <select name="language" id="language" required>
                {% for code, name in languages.items() %}
                    <option value="{{ code }}">{{ name }}</option>
                {% endfor %}
            </select><br>

            <input type="submit" value="ابدأ الدبلجة">
        </form>
    </div>
</body>
</html>
"""

@app.route('/')
def index():
    return render_template_string(HTML_TEMPLATE, languages=LANGUAGES)

@app.route('/dub', methods=['POST'])
def dub_video():
    if 'video' not in request.files:
        return "لم يتم رفع أي فيديو", 400

    video_file = request.files['video']
    if video_file.filename == '':
        return "لم يتم اختيار ملف", 400

    # الحصول على اللغة المختارة
    target_lang = request.form.get('language')
    if target_lang not in LANGUAGES:
        return "اختيار لغة غير صالح", 400

    # حفظ الفيديو
    video_path = os.path.join(app.config['UPLOAD_FOLDER'], video_file.filename)
    video_file.save(video_path)

    # 1. استخراج الصوت
    video_clip = VideoFileClip(video_path)
    audio_clip_path = os.path.join(app.config['UPLOAD_FOLDER'], "temp_audio.wav")
    video_clip.audio.write_audiofile(audio_clip_path)

    # 2. تحويل الكلام إلى نص (الإنجليزية فقط كبداية)
    r = Recognizer()
    with AudioFile(audio_clip_path) as source:
        audio = r.record(source)
    try:
        text_en = r.recognize_google(audio, language='en-US')
    except Exception as e:
        return f"خطأ في التعرف على الكلام: {e}", 500

    # 3. الترجمة إلى اللغة المختارة
    translator = Translator()
    text_translated = translator.translate(text_en, dest=target_lang).text

    # 4. تحويل النص المترجم إلى صوت
    tts = gTTS(text=text_translated, lang=target_lang, slow=False)
    new_audio_path = os.path.join(app.config['UPLOAD_FOLDER'], "new_audio.mp3")
    tts.save(new_audio_path)

    # 5. دمج الصوت الجديد مع الفيديو
    new_audio_clip = AudioFileClip(new_audio_path)
    final_clip = video_clip.set_audio(new_audio_clip)
    final_video_path = os.path.join(app.config['UPLOAD_FOLDER'], f"dubbed_{video_file.filename}")
    final_clip.write_videofile(final_video_path, codec="libx264", audio_codec="aac")

    # تنظيف الملفات المؤقتة
    os.remove(video_path)
    os.remove(audio_clip_path)
    os.remove(new_audio_path)

    return send_file(final_video_path, as_attachment=True)

if __name__ == '__main__':
    app.run(debug=True)
